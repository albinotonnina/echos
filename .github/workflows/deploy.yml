name: Deploy to Oracle Cloud

on:
  workflow_dispatch:   # manual trigger only — automatic deploys happen via release.yml on git tags

jobs:
  deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # ── 1. Checkout ──────────────────────────────────────────────────────────
      - name: Checkout
        uses: actions/checkout@v6

      # ── 2. Set up Docker Buildx ───────────────────────────────────────────────
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ── 3. Build Docker image for Oracle Cloud (x86_64 / amd64) ─────────────
      #      GitHub Actions runners are also x86_64 — native build, no emulation
      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile
          platforms: linux/amd64
          push: false
          load: true
          tags: echos:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ── 4. Save image to tar.gz ───────────────────────────────────────────────
      - name: Save image
        run: |
          docker save echos:latest | gzip > /tmp/echos.tar.gz
          echo "Image size: $(du -h /tmp/echos.tar.gz | cut -f1)"

      # ── 5. Set up SSH ─────────────────────────────────────────────────────────
      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ORACLE_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "${{ secrets.ORACLE_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null

      # ── 6. Create remote directories ──────────────────────────────────────────
      - name: Prepare remote directories
        run: |
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            "${{ secrets.ORACLE_USER }}@${{ secrets.ORACLE_HOST }}" \
            'mkdir -p echos/docker echos/data/{knowledge,db,sessions,logs} && sudo chown -R 1000:1000 echos/data/'

      # ── 7. Upload image ───────────────────────────────────────────────────────
      - name: Upload Docker image
        run: |
          scp -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            /tmp/echos.tar.gz \
            "${{ secrets.ORACLE_USER }}@${{ secrets.ORACLE_HOST }}:/tmp/echos.tar.gz"

      # ── 8. Upload docker-compose.yml ──────────────────────────────────────────
      - name: Upload docker-compose.yml
        run: |
          scp -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            docker/docker-compose.yml \
            "${{ secrets.ORACLE_USER }}@${{ secrets.ORACLE_HOST }}:echos/docker/docker-compose.yml"

      # ── 9. Upload .env ────────────────────────────────────────────────────────
      #      The ENV_FILE secret should contain your full .env file contents.
      #      It is written to a temp file and removed after upload — never logged.
      - name: Upload .env
        run: |
          printf '%s' "${{ secrets.ENV_FILE }}" > /tmp/echos.env
          chmod 600 /tmp/echos.env
          scp -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            /tmp/echos.env \
            "${{ secrets.ORACLE_USER }}@${{ secrets.ORACLE_HOST }}:echos/.env"
          rm /tmp/echos.env

      # ── 10. Load image and restart ────────────────────────────────────────────
      - name: Deploy on Oracle Cloud
        run: |
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            "${{ secrets.ORACLE_USER }}@${{ secrets.ORACLE_HOST }}" << 'ENDSSH'
            set -e
            cd echos

            mkdir -p data/knowledge data/db data/sessions data/logs
            sudo chown -R 1000:1000 data/

            echo "Loading Docker image..."
            docker load < /tmp/echos.tar.gz

            echo "Restarting services..."
            cd docker
            docker compose down
            docker compose up -d

            rm /tmp/echos.tar.gz

            echo "Waiting for services..."
            sleep 5

            docker compose ps
            echo ""
            echo "Recent logs:"
            docker compose logs --tail=20 echos
          ENDSSH

      # ── 11. Smoke test ────────────────────────────────────────────────────────
      - name: Health check
        run: |
          sleep 10
          curl --fail --silent --max-time 10 \
            "http://${{ secrets.ORACLE_HOST }}:${{ secrets.WEB_PORT || '3000' }}/health" \
            && echo "Health check passed" \
            || echo "Health check failed (non-fatal — web may be disabled)"
        continue-on-error: true
